{% extends 'base.html.twig' %}

{% block title %}MealPlan index{% endblock %}

{% block body %}
<div class="container bg-white p-4 rounded shadow mt-5">
    <h1 class="mb-3">My Meal Plans ü•£üóìÔ∏è </h1>
    <p class="mb-3 text-muted">Today is {{ now|date('l, j F Y ‚Äì H:i') }}</p>
    <a href="{{ path('app_meal_plan_index') }}" class="btn btn-sm custom-button mb-3">
    üóìÔ∏è See Current Week</a>

    <!-- Centered Day Buttons with Dates -->
    <div class="d-flex justify-content-center align-items-center mb-4 gap-3">
        
        <!-- Previous Week -->
        <a href="{{ path('app_meal_plan_index', {'week': offset - 1,'day': currentDate}) }}" class="btn custom-button">&laquo;</a>

        <!-- Day Buttons -->
        <div class="btn-group" role="group">
            {% for day in weekDays %}
                <a href="{{ path('app_meal_plan_index', {'week': offset, 'day': day.date}) }}"
                    class="btn custom-button-calender {% if day.date == currentDate %}active{% endif %}">
                    {{ day.label }}<br>
                    <small class="text-muted">{{ day.display }}</small>
                </a>
            {% endfor %}
        </div>
        
        <!-- Next Week -->
        <a href="{{ path('app_meal_plan_index', {'week': offset + 1,'day': currentDate}) }}" class="btn custom-button">&raquo;</a>
    </div>

<!-- Calories estimation section -->
<div class="text-center my-4">
    {% set totalCalories = 0 %}
    {% for mp in meal_plans %}
        {% if mp.mealDate|date('Y-m-d') == currentDate and mp.recipe %}
            {% set totalCalories = totalCalories + mp.recipe.calories %}
        {% endif %}
    {% endfor %}

    <div class="alert alert-info d-inline-block px-4 py-3 shadow-sm rounded">
        <h5 class="mb-0">Estimated Daily Calories: <strong>{{ totalCalories }}</strong> kcal</h5>
    </div>
</div>



{% set currentDayData = weekDays|filter(d => d.date == currentDate)|first %}

<!-- Cards with meals -->
    <div class="row" id="meal-cards">
    {% set meals = ['Breakfast', 'Lunch', 'Dinner', 'Supper'] %}

    {% for meal in meals %}
        {% set plan = null %}
        {% for mp in meal_plans %}
            {% if plan is null and mp.mealtime.value|lower == meal|lower %}
            {% set plan = mp %}
            {% endif %}
        {% endfor %}

        <div class="col-md-3 mb-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">{{ meal }}</h5>
                    {% if plan %}
                        <p class="card-text"><strong>{{ plan.recipe.title }}</strong></p>
                        <img src="{{ asset('images/recipeUploads/' ~ plan.recipe.image) }}" class="card-img-top p-2" alt="{{ plan.recipe.title }}">  
                        <a href="{{ path('app_meal_plan_edit', {'id': plan.id}) }}" class="btn btn-sm my-2 w-100 custom-button">‚úé Edit</a>
                        <a href="{{ path('app_meal_plan_show', {'id': plan.id}) }}" class="btn btn-sm my-2 w-100 custom-button">Show Recipe</a>
                    {% else %}
                        <p class="card-text text-muted">No meal assigned</p>

                        <a href="{{ path('app_meal_plan_new', {
                            date: currentDayData.date|default(currentDate),
                            day: currentDayData.label|default(''),
                            mealtime: meal|lower}) }}" 
                            class="btn btn-sm btn-outline-secondary">Assign Recipe
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endfor %}
    </div>

</div>

{% endblock %}
